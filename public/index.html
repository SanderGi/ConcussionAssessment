<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCAT6 Web</title>

    <link rel="icon" type="image/webp" href="/assets/icon.webp">
    <link rel="stylesheet" href="styles.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <header>
        <div>
            <img src="assets/icon.webp">
            <h1>SCAT6 Web</h1>
        </div>
        <div>
            <button class="button button--red" id="delete-all-button">Delete All &nbsp; <i class="fa-solid fa-trash"></i></button>
            <button class="button" id="sync-button">Sync &nbsp; <i class="fa-brands fa-google-drive"></i></button>
            <a class="button" href="https://github.com/SanderGi/SCAT6">About &nbsp; <i class="fa-solid fa-book"></i></a>
        </div>
    </header>
    <main id="test-management">
        <section>
            <h2>Concussion Assessment Management</h2>
            <p>Use this web app to administer concussion assessments for your athletes. The data is stored locally in your browser unless you "Delete All". You can also sync the data with your Google Drive.</p>
            <p>Click the round add button below to add an athlete profile. This will start a baseline assessment and create an athlete profile that you can use to compare concussion scores over time for the athlete.</p>
        </section>
        <section>
            Search by name: <input type="search" id="search-input" placeholder="Enter part of an athlete name"> <select id="number-of-athletes" aria-label="how many athletes to show">
                <option value="5">Show 5</option>
                <option value="10">Show 10</option>
                <option value="50">Show 50</option>
                <option value="9999">Show All</option>
            </select>
        </section>
        <div id="athletes" style="width: 100%;" class="center"></div>
        <button class="add" id="add-athlete-button" aria-label="add athlete">
            <i class="fa-solid fa-plus"></i>
        </button>
    </main>
    <main style="display: none;" id="red-flags">
        <section>
            <h2>Red Flags</h2>
            <p>Red flags are signs and symptoms that may indicate a more serious injury. If any of these are present, the athlete should be referred to a healthcare professional immediately.</p>
            <ul style="text-align: left;">
                <li>Neck pain or tenderness</li>
                <li>Seizure or convulsion</li>
                <li>Double vision</li>
                <li>Loss of consciousness</li>
                <li>Weakness or tingling/burning in more than 1 arm or in the legs</li>
                <li>Deteriorating conscious state</li>
                <li>Vomiting</li>
                <li>Severe or increasing headache</li>
                <li>Increasingly restless, agitated or combative</li>
                <li>Visible deformity of the skull</li>
            </ul>
            <button class="button button--red" onclick="saveTestResult('red_flags', 'YES'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Centre'); endTest()">Red flags present</button>
            <button class="button button--green" onclick="saveTestResult('red_flags', 'NO'); renderTestSection('obervable-signs')">No red flags</button>
        </section>
    </main>
    <main style="display: none;" id="obervable-signs">
        <section>
            <h2>Observable Signs</h2>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Lying motionless on playing surface: <input type="checkbox" /></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Falling unprotected to the surface: <input type="checkbox" /></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Balance/gait difficulties, motor incoordination, ataxia: stumbling, slow/laboured movements: <input type="checkbox" /></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Disorientation or confusion, staring or limited responsiveness, or an inability to respond appropriately to questions: <input type="checkbox" /></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Blank or vacant look: <input type="checkbox" /></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Facial injury after head trauma: <input type="checkbox" /></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Impact seizure: <input type="checkbox" /></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">High-risk mechanism of injury (sportdependent): <input type="checkbox" /></label>
            <br><br>
            <button class="button button--red" onclick="saveTestResult('observable_signs', 'WITNESSED'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Centre'); endTest()">Witnessed</button>
            <button class="button button--red" onclick="saveTestResult('observable_signs', 'VIDEO'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Centre'); endTest()">Observed on Video</button>
            <button class="button button--green" onclick="saveTestResult('observable_signs', 'NO'); renderTestSection('glasgow-scale')">None</button>
        </section>
    </main>
    <main style="display: none;" id="glasgow-scale">
        <!-- Glasgow Coma Scale < 15 => red flag -->
    </main>
    <main style="display: none;" id="cervical-spine">
        
    </main>
    <main style="display: none;" id="coordination">
        
    </main>
    <main style="display: none;" id="maddocks-score">
        
    </main>
    <main style="display: none;" id="symptom-evaluation-baseline">

    </main>
    <main style="display: none;" id="symptom-evaluation-post">

    </main>
    <main style="display: none;" id="bess">
        <section>
            <h2>Balance Error Scoring System <a style="font-size: 0.6em; vertical-align: middle;" href="./assets/bess_manual.pdf" target="_blank" aria-label="Manual BESS instructions"><i class="fa-solid fa-circle-info"></i></a></h2>
            <p style="margin-top: 0;">The athlete will be guided through 3 poses (double leg, tandem, and single leg stance) to be held for 20 seconds each. The later foam pad test is optional, only a solid floor/ground surface is required. You'll need a spotter to keep an eye on the athlete and be ready to assist them if they become unstable and begin to fall.</p>
            <p>Your job as examiner is to keep the camera as still as possible (minor shakes are fine) with the athlete fully in frame at all times. In case the automated system misses something, keep a count of the following errors in the athlete's execution of the poses:</p>
            <ul>
                <li style="text-align: left;">Opening eyes</li>
                <li style="text-align: left;">Lifting hands off iliac crests (upper border of the pelvis/hip-bone)</li>
                <li style="text-align: left;">Stepping, stumbling, or falling</li>
                <li style="text-align: left;">Abduction or flexion of the hip beyond 30 degrees (moving hips forwards/backwards/sideways)</li>
                <li style="text-align: left;">Twisting of the shoulder beyond 30 degrees</li>
                <li style="text-align: left;">Remaining out of the testing position for more than 5 seconds</li>
                <li style="text-align: left;">Lifting forefoot or heel</li>
            </ul>
            <canvas id="canvas" width="0" height="0" style="max-width: 100%; max-height: 70vh;"></canvas>
            <video id="video" style="display:none"></video><br>
            <!-- <canvas id="debug" width="800" height="800" style="max-width: 100%;"></canvas> -->
            <div id="status" style="width: 100%; padding: 10px; background-color: gray;" class="center">Getting camera permissions...</div>
            <button class="button" id="mirror-button">Mirror &nbsp; <i class="fa-solid fa-arrow-right-arrow-left"></i></button>
            <button class="button button--red" onclick="renderTestSection('manual-bess')">Skip to Manual Assessment &nbsp; <i class="fa-solid fa-forward"></i></button>

            <script src="./lib/tensorflow/tfjs-core.js"></script>
            <script src="./lib/tensorflow/tfjs-converter.js"></script>
            <script src="./lib/tensorflow/tfjs-backend-webgl.js"></script>
            <script src="./lib/tensorflow/pose-detection.js"></script>
            <script src="./lib/tensorflow/face-detection.js"></script>
            <script src="./lib/tensorflow/face-landmarks-detection.js"></script>
            <script src="./lib/three.min.js"></script>
            <script src="./lib/scatter-gl.min.js"></script>
            <script src="./lib/tracker.js"></script>
            <script>
                const statusElement = document.getElementById('status');

                const test = JSON.parse(sessionStorage.getItem('test'));
                const athlete_name = test?.athlete_name ?? 'Athlete';

                tracker.setModel('BlazePoseFull');
                tracker.elCanvas = '#canvas';
                tracker.elVideo = '#video';
                tracker.idealFacingMode = 'environment';

                document.addEventListener('renderTestSection', async (event) => {
                    if (event.detail === 'bess') {
                        tracker.idealWidth = document.getElementById('bess').clientWidth;
                        tracker.idealHeight = document.getElementById('bess').clientHeight * 2;
                        tracker.run('camera');

                        tracker.faceModel = await faceLandmarksDetection.createDetector(
                            faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
                            { maxFaces: 1, runtime: 'tfjs', refineLandmarks: false },
                        );
                    }
                });

                let status_text, status_id;
                function setStatus(id, status, color) {
                    if (status) {
                        statusElement.innerHTML = status;
                        status_text = status;
                    }
                    if (color) {
                        statusElement.style.backgroundColor = color;
                    }
                    status_id = id;

                    if (status_id === '') {
                        setStatus('BEGIN_DOUBLE', BEGIN_DOUBLE_TEXT, 'orange');
                    }
                }

                const EYE_ASPECT_RATIO_THRESHOLD = 0.013;
                function getEucledianDistance(x1, y1, x2, y2, z1, z2) {
                    return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1) + (z2 - z1) * (z2 - z1));
                }
                function getMidPoint(a, b) {
                    return {
                            x: (a.x + b.x) / 2,
                            y: (a.y + b.y) / 2,
                            z: (a.z + b.z) / 2,
                        };
                }
                function getScaledDistance(a, b, scale=1) {
                    return getEucledianDistance(a.x, a.y, b.x, b.y, a.z, b.z) / scale;
                }
                async function isEyesClosed(boundingBox) {
                    let isEyeClosed = true;
                    let image = tracker.video;
                    // clip video to bounding box
                    if (boundingBox) {
                        const [x, y, width, height] = boundingBox;
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(tracker.video, x, y, width, height, 0, 0, width, height);
                        image = canvas;
                        // // draw to debug canvas
                        // const debugCtx = document.getElementById('debug').getContext('2d');
                        // debugCtx.clearRect(0, 0, 1000, 1000);
                        // debugCtx.drawImage(image, 0, 0, width, height);
                    }
                    const predictions = await tracker.faceModel.estimateFaces(image);
                    if (predictions.length > 0) {
                        prediction = predictions[0];
                        const rightEye = prediction.keypoints.filter(kp => kp.name === 'rightEye');
                        const [lowerRight, upperRight] = rightEye[0].y > rightEye[1].y ? [rightEye[1], rightEye[0]] : [rightEye[0], rightEye[1]];

                        const leftEye = prediction.keypoints.filter(kp => kp.name === 'leftEye');
                        const [lowerLeft, upperLeft] = leftEye[0].y > leftEye[1].y ? [leftEye[1], leftEye[0]] : [leftEye[0], leftEye[1]];

                        const averageRight = getMidPoint(lowerRight, upperRight);
                        const averageLeft = getMidPoint(lowerLeft, upperLeft);
                        const distance = getScaledDistance(averageLeft, averageRight, 1);
                        const rightHeight = getEucledianDistance(0, lowerRight.y, 0, upperRight.y, 0, 0);
                        const leftHeight = getEucledianDistance(0, lowerLeft.y, 0, upperLeft.y, 0, 0);
                        const leftEAR = leftHeight / distance;
                        const rightEAR = rightHeight / distance;

                        isEyeClosed = leftEAR <= EYE_ASPECT_RATIO_THRESHOLD || rightEAR <= EYE_ASPECT_RATIO_THRESHOLD;
                    } else {
                        console.log('No face detected');
                    }
                    return isEyeClosed;
                }

                let max_shoulder_width = 0;
                const BEGIN_DOUBLE_TEXT = athlete_name + ', please stand straight with hands on your hips and feet touching: <img src="./assets/double_leg.png" style="height: 4cm; margin-bottom: 6px">';
                async function begin_double(poses) {
                    if (poses.length === 0) {
                        setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Can\'t find athlete. Please make sure they are fully in frame.', 'red');
                    } else if (poses.length > 1) {
                        setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Multiple people detected. Please make sure only ' + athlete_name + ' is in frame.', 'red');
                    } else {
                        const pose = poses[0];
                        const left_shoulder = pose.keypoints3D.find(kp => kp.name === 'left_shoulder');
                        const right_shoulder = pose.keypoints3D.find(kp => kp.name === 'right_shoulder');
                        const left_elbow = pose.keypoints3D.find(kp => kp.name === 'left_elbow');
                        const right_elbow = pose.keypoints3D.find(kp => kp.name === 'right_elbow');
                        const left_wrist = pose.keypoints3D.find(kp => kp.name === 'left_wrist');
                        const right_wrist = pose.keypoints3D.find(kp => kp.name === 'right_wrist');
                        const left_hip = pose.keypoints3D.find(kp => kp.name === 'left_hip');
                        const right_hip = pose.keypoints3D.find(kp => kp.name === 'right_hip');
                        const left_knee = pose.keypoints3D.find(kp => kp.name === 'left_knee');
                        const right_knee = pose.keypoints3D.find(kp => kp.name === 'right_knee');
                        const left_ankle = pose.keypoints3D.find(kp => kp.name === 'left_ankle');
                        const right_ankle = pose.keypoints3D.find(kp => kp.name === 'right_ankle');
                        const left_heel = pose.keypoints3D.find(kp => kp.name === 'left_heel');
                        const right_heel = pose.keypoints3D.find(kp => kp.name === 'right_heel');
                        const left_foot_index = pose.keypoints3D.find(kp => kp.name === 'left_foot_index');
                        const right_foot_index = pose.keypoints3D.find(kp => kp.name === 'right_foot_index');

                        const body_parts = [left_shoulder, right_shoulder, left_elbow, right_elbow, left_wrist, right_wrist, left_hip, right_hip, left_knee, right_knee, left_ankle, right_ankle, left_heel, right_heel, left_foot_index, right_foot_index];
                        const display_names = ['Left shoulder', 'Right shoulder', 'Left elbow', 'Right elbow', 'Left wrist', 'Right wrist', 'Left hip', 'Right hip', 'Left knee', 'Right knee', 'Left ankle', 'Right ankle', 'Left heel', 'Right heel', 'Left forefoot', 'Right forefoot'];
                        for (let i = 0; i < body_parts.length; i++) {
                            if (body_parts[i].score < tracker.minScore) {
                                setStatus(status_id, BEGIN_DOUBLE_TEXT + display_names[i] + ' not detected. Please make sure it is fully in frame and you are facing the camera straight on.', 'red');
                                return;
                            }
                        }

                        // max shoulder width is useful as a reference for the other measurements
                        const shoulderWidth = getEucledianDistance(left_shoulder.x, left_shoulder.y, right_shoulder.x, right_shoulder.y, left_shoulder.z, right_shoulder.z);
                        if (shoulderWidth > max_shoulder_width) {
                            max_shoulder_width = shoulderWidth;
                        }
                        
                        if (shoulderWidth < 0.5 * max_shoulder_width) {
                            setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Please face the camera straight on.', 'red');
                            return;
                        }

                        const left_hand_hip_distance = getScaledDistance(left_wrist, left_hip, max_shoulder_width);
                        if (left_hand_hip_distance > 0.7) {
                            setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Left hand is too far from the hip. Please move it closer.', 'red');
                            return;
                        }
                        const right_hand_hip_distance = getScaledDistance(right_wrist, right_hip, max_shoulder_width);
                        if (right_hand_hip_distance > 0.7) {
                            setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Right hand is too far from the hip. Please move it closer.', 'red');
                            return;
                        }

                        const minZ = Math.min(...body_parts.map(kp => kp.z));
                        const maxZ = Math.max(...body_parts.map(kp => kp.z));
                        const foward_backward_bending_factor = (maxZ - minZ) / shoulderWidth;
                        if (foward_backward_bending_factor > 1.4) {
                            setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Please stand straight without bending/twisting knees or upper body.', 'red');
                            return;
                        }

                        const left_hip_shoulder_distance = getEucledianDistance(left_hip.x, 0, left_shoulder.x, 0, 0, 0);
                        const right_hip_shoulder_distance = getEucledianDistance(right_hip.x, 0, right_shoulder.x, 0, 0, 0);
                        const max_hip_shoulder_distance = Math.max(left_hip_shoulder_distance, right_hip_shoulder_distance);
                        const left_right_bending_factor = max_hip_shoulder_distance / shoulderWidth;
                        if (left_right_bending_factor > 0.24) {
                            setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Please stand straight without moving hip side to side.', 'red');
                            return;
                        }

                        // console.log(left_ankle, left_heel, left_foot_index);

                        // calculate bounding box from pose.keypoints
                        const x = Math.min(...pose.keypoints.map(kp => kp.x));
                        const y = Math.min(...pose.keypoints.map(kp => kp.y)) * 0.6;
                        const width = Math.max(...pose.keypoints.map(kp => kp.x)) - x;
                        const height = Math.max(...pose.keypoints.map(kp => kp.y)) * 0.6 - y;
                        const boundingBox = [x, y, width, height];

                        if (await isEyesClosed(boundingBox)) {
                            setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Pose looks good! Click to start the 20 second trial where the pose must be held <button class="button button--green" data-action="start-double-timer">Start Timer</button>', 'green');
                        } else {
                            setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Please close your eyes.', 'red');
                        }
                    }
                }
                
                async function count_double_errors(poses) {
                    if (poses.length === 0) {
                        setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Can\'t find athlete. Please make sure they are fully in frame.', 'red');
                    } else if (poses.length > 1) {
                        setStatus(status_id, BEGIN_DOUBLE_TEXT + 'Multiple people detected. Please make sure only ' + athlete_name + ' is in frame.', 'red');
                    } else {
                        const pose = poses[0];
                        const left_shoulder = pose.keypoints3D.find(kp => kp.name === 'left_shoulder');
                        const right_shoulder = pose.keypoints3D.find(kp => kp.name === 'right_shoulder');
                        const left_elbow = pose.keypoints3D.find(kp => kp.name === 'left_elbow');
                        const right_elbow = pose.keypoints3D.find(kp => kp.name === 'right_elbow');
                        const left_wrist = pose.keypoints3D.find(kp => kp.name === 'left_wrist');
                        const right_wrist = pose.keypoints3D.find(kp => kp.name === 'right_wrist');
                        const left_index = pose.keypoints3D.find(kp => kp.name === 'left_index');
                        const right_index = pose.keypoints3D.find(kp => kp.name === 'right_index');
                        const left_hip = pose.keypoints3D.find(kp => kp.name === 'left_hip');
                        const right_hip = pose.keypoints3D.find(kp => kp.name === 'right_hip');
                        const left_knee = pose.keypoints3D.find(kp => kp.name === 'left_knee');
                        const right_knee = pose.keypoints3D.find(kp => kp.name === 'right_knee');
                        const left_ankle = pose.keypoints3D.find(kp => kp.name === 'left_ankle');
                        const right_ankle = pose.keypoints3D.find(kp => kp.name === 'right_ankle');
                        const left_heel = pose.keypoints3D.find(kp => kp.name === 'left_heel');
                        const right_heel = pose.keypoints3D.find(kp => kp.name === 'right_heel');
                        const left_foot_index = pose.keypoints3D.find(kp => kp.name === 'left_foot_index');
                        const right_foot_index = pose.keypoints3D.find(kp => kp.name === 'right_foot_index');
                    }
                }

                const BEGIN_TANDEM_TEXT = athlete_name + ', please stand heel-to-toe with hands on your hips: <img src="./assets/tandem.png" style="height: 5cm; margin-bottom: 6px>';
                async function begin_tandem(poses) {

                }


                statusElement.addEventListener('click', async (event) => {
                    if (event.target.dataset.action === 'start-double-timer') {
                        setStatus('DOUBLE_LEG', athlete_name + ', please hold the pose for 20 seconds: <img src="./assets/double_leg.png" style="height: 4cm; margin-bottom: 6px>', 'green');
                        let seconds_left = 20;
                        const timer = setInterval(() => {
                            seconds_left -= 1;
                            if (seconds_left <= 0) {
                                setStatus('BEGIN_TANDEM', BEGIN_TANDEM_TEXT, 'orange');
                                clearInterval(timer);
                            } else {
                                setStatus('DOUBLE_LEG', athlete_name + ', please hold the pose for ' + seconds_left + ' seconds: <img src="./assets/double_leg.png" style="height: 5cm; margin-bottom: 6px>', 'green');
                            }
                        }, 1000);
                    }
                });

                let _prev_status = '';
                tracker.on('statuschange', function(status) {
                    if (status === _prev_status) return;
                    setStatus(status, status, 'gray');
                    _prev_status = status;
                });

                tracker.on('detectorerror', async (error) => {
                    console.error(error);
                    await alert("Unexpected error deciphering the pose. Skipping to manual assessment.");
                    renderTestSection('manual-bess');
                });
                tracker.on('videoerror', async (error) => {
                    console.error(error);
                    await alert("Unexpected error with the camera. Skipping to manual assessment.");
                    renderTestSection('manual-bess');
                });

                let count = 0;
                tracker.on('beforeupdate', (poses) => {
                    count %= 30;
                    if (count === 0) {
                        if (status_id === 'BEGIN_DOUBLE') {
                            begin_double(poses);
                        }
                    }
                    count += 1;
                });

                document.getElementById('mirror-button').addEventListener('click', () => {
                    const video = document.getElementById('video');
                    const canvas = document.getElementById('canvas');
                    video.style.transform = video.style.transform === 'scaleX(-1)' ? 'scaleX(1)' : 'scaleX(-1)';
                    canvas.style.transform = canvas.style.transform === 'scaleX(-1)' ? 'scaleX(1)' : 'scaleX(-1)';
                });
            </script>
        </section>
    </main>
    <main style="display: none;" id="manual-bess"></main>
    <footer>
        <p><a href="https://bjsm.bmj.com/content/bjsports/57/11/622.full.pdf">SCAT6</a> © by the <a href="https://www.bmj.com/">BMJ</a> | Adaptation with permission by Aureole and <a href="https://sandergi.github.io/">Alex</a> | <a href="https://github.com/SanderGi/SCAT6">Code</a> opensource under <a href="https://github.com/SanderGi/SCAT6/blob/master/LICENSE">MIT license</a></p>
    </footer>

    <script type="module" src="scripts.js"></script>
  </body>
</html>
