<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCAT6 Web</title>

    <link rel="icon" type="image/webp" href="/assets/icon.webp">
    <link rel="stylesheet" href="styles.css">

    <script src="./lib/chart.js"></script>
  </head>
  <body>
    <header>
        <div>
            <img src="assets/icon.webp">
            <h1>SCAT6 Web</h1>
        </div>
        <div>
            <button class="button button--red" id="delete-all-button">Delete All &nbsp; <i class="fa-solid fa-trash"></i></button>
            <button class="button" id="sync-button">Sync &nbsp; <i class="fa-brands fa-google-drive"></i></button>
            <a class="button" href="https://github.com/SanderGi/SCAT6">About &nbsp; <i class="fa-solid fa-book"></i></a>
        </div>
    </header>
    <main id="test-management">
        <section>
            <h2>Concussion Assessment Management</h2>
            <p>Use this web app to administer concussion assessments for your athletes. The data is stored locally in your browser unless you "Delete All". You can also sync the data with your Google Drive.</p>
            <p>Click the round add button below to add an athlete profile. This will start a baseline assessment and create an athlete profile that you can use to compare concussion scores over time for the athlete.</p>
        </section>
        <section>
            Search by name: <input type="search" id="search-input" placeholder="Enter part of an athlete name"> <select id="number-of-athletes" aria-label="how many athletes to show">
                <option value="5">Show 5</option>
                <option value="10">Show 10</option>
                <option value="50">Show 50</option>
                <option value="9999">Show All</option>
            </select>
        </section>
        <div id="athletes" style="width: 100%;" class="center"></div>
        <button class="add" id="add-athlete-button" aria-label="add athlete">
            <i class="fa-solid fa-plus"></i>
        </button>
    </main>
    <main style="display: none;" id="red-flags">
        <section>
            <h2>Red Flags</h2>
            <p>Red flags are signs and symptoms that may indicate a more serious injury. If any of these are present, the athlete should be referred to a healthcare professional immediately.</p>
            <ul style="text-align: left;">
                <li>Neck pain or tenderness</li>
                <li>Seizure or convulsion</li>
                <li>Double vision</li>
                <li>Loss of consciousness</li>
                <li>Weakness or tingling/burning in more than 1 arm or in the legs</li>
                <li>Deteriorating conscious state</li>
                <li>Vomiting</li>
                <li>Severe or increasing headache</li>
                <li>Increasingly restless, agitated or combative</li>
                <li>Visible deformity of the skull</li>
            </ul>
            <button class="button button--red" onclick="saveTestResult('red_flags', 'YES'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Centre'); endTest()">Red flags present</button>
            <button class="button button--green" onclick="saveTestResult('red_flags', 'NO'); renderTestSection('obervable-signs')">No red flags</button>
        </section>
    </main>
    <main style="display: none;" id="obervable-signs">
        <section>
            <h2>Observable Signs</h2>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Lying motionless on playing surface: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Falling unprotected to the surface: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Balance/gait difficulties, motor incoordination, ataxia: stumbling, slow/laboured movements: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Disorientation or confusion, staring or limited responsiveness, or an inability to respond appropriately to questions: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Blank or vacant look: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Facial injury after head trauma: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Impact seizure: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">High-risk mechanism of injury (sportdependent): <input type="checkbox" class="observable-signs"/></label>
            <br><br>
            <button class="button button--red" onclick="saveTestResult('observable_signs', getChecked('observable-signs')); saveTestResult('observable_signs_source', 'WITNESSED'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Centre'); endTest()">Witnessed</button>
            <button class="button button--red" onclick="saveTestResult('observable_signs', getChecked('observable-signs')); saveTestResult('observable_signs_source', 'VIDEO'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Centre'); endTest()">Observed on Video</button>
            <button class="button button--green" onclick="saveTestResult('observable_signs', []); saveTestResult('observable_signs_source', 'NO'); renderTestSection('glasgow-scale')">None</button>
        </section>
    </main>
    <main style="display: none;" id="glasgow-scale">
        <!-- Glasgow Coma Scale < 15 => red flag -->
    </main>
    <main style="display: none;" id="cervical-spine">
        
    </main>
    <main style="display: none;" id="coordination">
        
    </main>
    <main style="display: none;" id="maddocks-score">
        
    </main>
    <main style="display: none;" id="symptom-evaluation-baseline">

    </main>
    <main style="display: none;" id="symptom-evaluation-post">

    </main>
    <main style="display: none;" id="bess">
        <section>
            <h2>Balance Error Scoring System <a style="font-size: 0.6em; vertical-align: middle;" href="./assets/bess_manual.pdf" target="_blank" aria-label="Manual BESS instructions"><i class="fa-solid fa-circle-info"></i></a></h2>
            <p style="margin-top: 0;">The athlete will be guided through 3 poses (double leg, tandem, and single leg stance) to be held for 20 seconds each. The later foam pad test is optional, only a solid floor/ground surface is required. You'll need a spotter to keep an eye on the athlete and be ready to assist them if they become unstable and begin to fall.</p>
            <p>The athlete should take their shoes off, roll up pant legs above ankles (if applicable), and remove any ankle taping (if applicable).</p>
            <p>Your job as examiner is to keep the camera as still as possible (minor shakes are fine) with the athlete fully in frame at all times. In case the automated system misses something, keep a count of the following errors in the athlete's execution of the poses:</p>
            <ul>
                <li style="text-align: left;">Opening eyes</li>
                <li style="text-align: left;">Lifting hands off iliac crests (upper border of the pelvis/hip-bone)</li>
                <li style="text-align: left;">Stepping, stumbling, or falling</li>
                <li style="text-align: left;">Abduction or flexion of the hip beyond 30 degrees (moving hips forwards/backwards/sideways)</li>
                <li style="text-align: left;">Twisting of the shoulder beyond 30 degrees</li>
                <li style="text-align: left;">Remaining out of the testing position for more than 5 seconds</li>
                <li style="text-align: left;">Lifting forefoot or heel</li>
            </ul>
            <p>Multiple simultaneous errors count as one. Failure to hold the pose for at least 5 seconds counts as the maximum number of errors (10).</p>

            <div id="instructions" style="bottom: 0; left: 0; width: 100%; padding: 10px; background-color: var(--secondary);" class="center"></div>
            <div style="position: relative;">
                <canvas id="canvas" width="0" height="0" style="max-width: 100%; max-height: 90vh;"></canvas>
                <video id="video" style="display:none"></video>
                <div id="status" style="opacity: 0.8; position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background-color: gray;" class="center">Getting camera permissions...</div>
            </div>
            <button class="button" id="voice-ctrl-button">Voice Ctrl &nbsp; <i class="fa-solid fa-microphone"></i></button>
            <button class="button" id="mirror-button">Mirror &nbsp; <i class="fa-solid fa-arrow-right-arrow-left"></i></button>
            <button class="button button--red" onclick="renderTestSection('manual-bess')">Assess Manually &nbsp; <i class="fa-solid fa-forward"></i></button>

            <script defer src="./lib/tensorflow/tfjs-core.js"></script>
            <script defer src="./lib/tensorflow/tfjs-converter.js"></script>
            <script defer src="./lib/tensorflow/tfjs-backend-webgl.js"></script>
            <script defer src="./lib/tensorflow/pose-detection.js"></script>
            <script defer src="./lib/tensorflow/face-detection.js"></script>
            <script defer src="./lib/tensorflow/face-landmarks-detection.js"></script>
            <script defer src="./lib/three.min.js"></script>
            <script defer src="./lib/scatter-gl.min.js"></script>
            <script defer src="./lib/tracker.js"></script>
            <script src="./bess.js" type="module"></script>
        </section>
    </main>
    <main style="display: none;" id="manual-bess"></main>
    <footer>
        <p><a href="https://bjsm.bmj.com/content/bjsports/57/11/622.full.pdf">SCAT6</a> © by the <a href="https://www.bmj.com/">BMJ</a> | Adaptation with permission by Aureole and <a href="https://sandergi.github.io/">Alex</a> | <a href="https://github.com/SanderGi/SCAT6">Code</a> opensource under <a href="https://github.com/SanderGi/SCAT6/blob/master/LICENSE">MIT license</a></p>
    </footer>

    <script type="module" src="scripts.js"></script>
  </body>
</html>
