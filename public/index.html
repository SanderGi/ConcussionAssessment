<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCAT6 Web</title>

    <link rel="icon" type="image/webp" href="/assets/icon.webp">
    <link rel="stylesheet" href="styles.css">

    <script src="./lib/chart.js"></script>
  </head>
  <body>
    <header>
        <div>
            <img src="assets/icon.webp">
            <h1>SCAT6 Web</h1>
        </div>
        <div>
            <button class="button button--red" id="delete-all-button">Delete All &nbsp; <i class="fa-solid fa-trash"></i></button>
            <button class="button" id="sync-button">Sync &nbsp; <i class="fa-brands fa-google-drive"></i></button>
            <a class="button" href="https://github.com/SanderGi/ConcussionAssessment">About &nbsp; <i class="fa-solid fa-book"></i></a>
        </div>
    </header>
    <main id="test-management">
        <section>
            <h2>Concussion Assessment Management</h2>
            <p>Use this web app to administer concussion assessments for your athletes. The data is stored locally in your browser unless you "Delete All". You can also sync the data with your Google Drive.</p>
            <p>Click the round add button below to add an athlete profile. This will start a baseline assessment and create an athlete profile that you can use to compare concussion scores over time for the athlete.</p>
        </section>
        <section>
            Search by name: <input type="search" id="search-input" placeholder="Enter part of an athlete name"> <select id="number-of-athletes" aria-label="how many athletes to show">
                <option value="5">Show 5</option>
                <option value="10">Show 10</option>
                <option value="50">Show 50</option>
                <option value="9999">Show All</option>
            </select>
        </section>
        <div id="athletes" style="width: 100%;" class="center"></div>
        <button class="add" id="add-athlete-button" aria-label="add athlete">
            <i class="fa-solid fa-plus"></i>
        </button>
    </main>
    <main style="display: none;" id="red-flags">
        <section>
            <h2>Red Flags</h2>
            <p>Red flags are signs and symptoms that may indicate a more serious injury. If any of these are present, the athlete should be referred to a healthcare professional immediately.</p>
            <ul style="text-align: left;">
                <li>Neck pain or tenderness</li>
                <li>Seizure or convulsion</li>
                <li>Double vision</li>
                <li>Loss of consciousness</li>
                <li>Weakness or tingling/burning in more than 1 arm or in the legs</li>
                <li>Deteriorating conscious state</li>
                <li>Vomiting</li>
                <li>Severe or increasing headache</li>
                <li>Increasingly restless, agitated or combative</li>
                <li>Visible deformity of the skull</li>
            </ul>
            <button class="button button--red" onclick="saveTestResult('red_flags', 'YES'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center'); endTest()">Red flags present</button>
            <button class="button button--green" onclick="saveTestResult('red_flags', 'NO'); renderTestSection('obervable-signs')">No red flags</button>
        </section>
    </main>
    <main style="display: none;" id="obervable-signs">
        <section>
            <h2>Observable Signs</h2>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Lying motionless on playing surface: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Falling unprotected to the surface: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Balance/gait difficulties, motor incoordination, ataxia: stumbling, slow/laboured movements: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Disorientation or confusion, staring or limited responsiveness, or an inability to respond appropriately to questions: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Blank or vacant look: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Facial injury after head trauma: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Impact seizure: <input type="checkbox" class="observable-signs"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">High-risk mechanism of injury (sportdependent): <input type="checkbox" class="observable-signs"/></label>
            <br><br>
            <button class="button button--red" onclick="saveTestResult('observable_signs', getChecked('observable-signs')); saveTestResult('observable_signs_source', 'WITNESSED'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center'); endTest()">Witnessed</button>
            <button class="button button--red" onclick="saveTestResult('observable_signs', getChecked('observable-signs')); saveTestResult('observable_signs_source', 'VIDEO'); alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center'); endTest()">Observed on Video</button>
            <button class="button button--green" onclick="saveTestResult('observable_signs', []); saveTestResult('observable_signs_source', 'NO'); renderTestSection('glasgow-scale')">None</button>
        </section>
    </main>
    <main style="display: none;" id="glasgow-scale">
        <!-- Glasgow Coma Scale < 15 => red flag -->
        <section>
            <h2>Glasgow Coma Scale</h2>
            <h3>Best Eye Response</h3>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">No eye opening for any reason: <input type="radio" name="eye-response" value="1"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Open to pain (pinch or poke): <input type="radio" name="eye-response" value="2"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Open to speech (when asked to open): <input type="radio" name="eye-response" value="3"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Open naturally: <input type="radio" name="eye-response" value="4"/></label>
            
            <h3>Best Verbal Response</h3>
            <p style="margin-top: 0">Does the athlete know their name, where they are at, the day/year, etc?</p>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">No verbal response: <input type="radio" name="verbal" value="1"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Incomprehensible sounds or noises: <input type="radio" name="verbal-response" value="2"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Inappropriate words. Random but comprehensible words: <input type="radio" name="verbal-response" value="3"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Confused. Answers but not fully aware what's happening: <input type="radio" name="verbal-response" value="4"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Oriented. Answers correctly.: <input type="radio" name="verbal-response" value="5"/></label>

            <h3>Best Motor Response</h3>
            <p style="margin-top: 0">Can the athlete follow instructions for how to move (e.g. "lift your arm") or respond to pain (pinch or poke)?</p>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">No motor response: <input type="radio" name="motor-response" value="1"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Extend (stretch outward) muscles to pain: <input type="radio" name="motor-response" value="2"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Abnormal flexion (pull muscles inward) to pain: <input type="radio" name="motor-response" value="3"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Flexion/withdrawal (as a reflex) to pain: <input type="radio" name="motor-response" value="4"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Intentionally moves away from pain: <input type="radio" name="motor-response" value="5"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Obeys commands: <input type="radio" name="motor-response" value="6"/></label>

            <button class="button button--green" id="complete-gcs-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('complete-gcs-btn').onclick = () => {
                    const score = getRadioInt('eye-response') + getRadioInt('verbal-response') + getRadioInt('motor-response');
                    if (isNaN(score)) {
                        alert('Please fill out all fields');
                        return;
                    }
                    saveTestResult('glasgow_coma_scale', score);
                    if (score < 15) {
                        alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center');
                        endTest();
                    } else {
                        renderTestSection('cervical-spine');
                    }
                }
            </script>
        </section>
    </main>
    <main style="display: none;" id="cervical-spine">
        <section>
            <h2>Cervical Spine</h2>
            <p style="margin-top: 0;">In a patient who is not lucid or fully conscious, a cervical spine injury should be assumed and spinal precautions taken.</p>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Athlete reports neck pain at rest: <input type="checkbox" class="cervical-spine" data-should="false"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">There is tenderness to palpation: <input type="checkbox" class="cervical-spine" data-should="false"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">If NO neck pain and NO tenderness, athlete has full range of ACTIVE pain free movement: <input type="checkbox" class="cervical-spine" data-should="true"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Limb strength and sensation is normal: <input type="checkbox" class="cervical-spine" data-should="true"/></label>

            <button class="button button--red" onclick="alert('Spinal Immobilization and cervical color. Then remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center'); endTest()">Not Fully Conscious</button>
            <button class="button button--green" id="complete-cervical-spine-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('complete-cervical-spine-btn').addEventListener('click', () => {
                    const checkboxes = document.querySelectorAll('.cervical-spine');
                    for (const checkbox of checkboxes) {
                        if (checkbox.checked.toString() !== checkbox.dataset.should) {
                            alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center');
                            endTest();
                            return;
                        }
                    }
                    renderTestSection('coordination');
                });
            </script>
        </section>
    </main>
    <main style="display: none;" id="coordination">
        <section>
            <h2>Coordination and Ocular/Motor Screen</h2>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Coordination. Finger-to-nose is normal for both hands with eyes open and closed: <input type="checkbox" class="coordination"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Ocular/Motor. Athlete can look side-to-side and up-and-down without moving their head/neck or getting double vision: <input type="checkbox" class="coordination"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Observed extraocular eye movements are normal: <input type="checkbox" class="coordination"/></label>
            <button class="button button--green" onclick="getChecked('coordination').length === 3 ? renderTestSection('maddocks-score') : (alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center') && endTest())">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
        </section>
    </main>
    <main style="display: none;" id="maddocks-score">
        <section>
            <h2>Maddocks Score</h2>
            <p style="margin-top: 0;">Examiner, read the following line and ask the following questions (modified to be appropriate to the relevant sport). Check the correctly answered questions.</p>
            <p>Athlete, you will be asked a few questions. Please listen carefully and give your best effort. First explain what happened? &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">What venue are we at today? <input type="checkbox" class="maddocks"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Which half is it now? <input type="checkbox" class="maddocks"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Who scored last in this match? <input type="checkbox" class="maddocks"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">What team did you play last week / game? <input type="checkbox" class="maddocks"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Did your team win the last game? <input type="checkbox" class="maddocks"/></label>
            <button class="button button--green" id="maddocks-end-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('maddocks-end-btn').addEventListener('click', () => {
                    const score = getChecked('maddocks').length;
                    saveTestResult('maddocks_score', score);
                    if (score < 4) {
                        alert('Remove athlete from Play for Immediate Medical Assessment or Transport to Hospital/Medical Center');
                        endTest();
                    } else {
                        const test = getTest();
                        if (test.test_type === 'BASELINE') {
                            renderTestSection('symptom-evaluation-baseline');
                        } else {
                            renderTestSection('symptom-evaluation-post');
                        }
                    }
                });
            </script>
        </section>
    </main>
    <main style="display: none;" id="symptom-evaluation-baseline">
        <section>
            <h2>Symptom Evaluation Baseline</h2>
            <p style="margin-top: 0">Examiner, please hand the device to the athlete to fill in the symptom scale (below) after you provide instructions.</p>
            <p>Athlete, please rate your symptoms below based on how you typically feel with 1 representing a very mild symptom and 6 representing a severe symptom. 0 means the symptom is not present &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Headaches: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Pressure in head: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Neck pain: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Nausea or vomiting: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Dizziness: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Blurred vision: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Balance problems: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Sensitivity to light: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Sensitivity to noise: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Feeling slowed down: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Feeling like "in a fog": <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">"Don't feel right": <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Difficulty concentrating: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Difficulty remembering: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Fatique or low energy: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Confusion: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Drowsiness: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">More emtional: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Irritability: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Sadness: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Nervous or anxious: <input type="number" class="symptom-baseline" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Trouble falling asleep: <input type="number" class="symptom-baseline" value="0"/></label>
            <button class="button button--green" id="symptom-baseline-end-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('symptom-baseline-end-btn').onclick = () => {
                    const symptoms = document.querySelectorAll('.symptom-baseline');
                    const numSymptoms = Array.from(symptoms).filter(s => parseInt(s.value) > 0).length;
                    const severity = Array.from(symptoms).map(s => parseInt(s.value)).reduce((a, b) => a + b, 0);
                    saveTestResult('symptom_number', numSymptoms);
                    saveTestResult('symptom_severity', severity);
                    renderTestSection('orientation');
                }
            </script>
        </section>
    </main>
    <main style="display: none;" id="symptom-evaluation-post">
        <section>
            <h2>Symptom Evaluation</h2>
            <p style="margin-top: 0">Examiner, please hand the device to the athlete to fill in the symptom scale (below) after you provide instructions.</p>
            <p>Athlete, please rate your symptoms below based on how you feel now with 1 representing a very mild symptom and 6 representing a severe symptom. 0 means the symptom is not present &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Headaches: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Pressure in head: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Neck pain: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Nausea or vomiting: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Dizziness: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Blurred vision: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Balance problems: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Sensitivity to light: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Sensitivity to noise: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Feeling slowed down: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Feeling like "in a fog": <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">"Don't feel right": <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Difficulty concentrating: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Difficulty remembering: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Fatique or low energy: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Confusion: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Drowsiness: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">More emtional: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Irritability: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Sadness: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Nervous or anxious: <input type="number" class="symptom" value="0"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Trouble falling asleep: <input type="number" class="symptom" value="0"/></label>
            <button class="button button--green" id="symptom-end-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('symptom-end-btn').onclick = () => {
                    const symptoms = document.querySelectorAll('.symptom');
                    const numSymptoms = Array.from(symptoms).filter(s => parseInt(s.value) > 0).length;
                    const severity = Array.from(symptoms).map(s => parseInt(s.value)).reduce((a, b) => a + b, 0);
                    saveTestResult('symptom_number', numSymptoms);
                    saveTestResult('symptom_severity', severity);
                    renderTestSection('orientation');
                }
            </script>
        </section>
    </main>
    <main style="display: none;" id="orientation">
        <section>
            <h2>Orientation</h2>
            <p style="margin-top: 0;">Examiner, ask the athlete the following questions and select the ones they answer correctly.</p>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">What month is it? <input type="checkbox" class="orientation"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">What is the date today? <input type="checkbox" class="orientation"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">What is the day of the week? <input type="checkbox" class="orientation"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">What year is it? <input type="checkbox" class="orientation"/></label>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">What time is it right now (within 1 hour)? <input type="checkbox" class="orientation"/></label>
            <button class="button button--green" id="orientation-end-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('orientation-end-btn').addEventListener('click', () => {
                    const score = getChecked('orientation').length;
                    saveTestResult('orientation', score);
                    renderTestSection('immediate-memory');
                });
            </script>
        </section>
    </main>
    <main style="display: none;" id="immediate-memory">
        <section>
            <h2>Orientation</h2>
            <p style="margin-top: 0;">Examiner, you will read the list of words below 3 times, keeping track of how many words the athlete remembers after each reading. Start the first trial by saying the following:</p>
            <p>Athlete, I am going to test your memory. I will read you a list of words and when I am done, repeat back as many words as you can remember, in any order &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <p>Examiner, for the second and third trials say the following:</p>
            <p>Athlete, I am going to repeat the same list. Repeat back as many words as you can remember in any order, even if you said the word before in a previous trial &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <ul id="wordlist"></ul>
            <table style="margin: auto;">
                <thead><tr><th>Trial 1</th><th>Trial 2</th><th>Trial 3</th></tr></thead>
                <tbody>
                    <tr id="immediate-memory-data">
                        <td data-title="Trial 1"><input type="number" value="0" style="min-width: 6ch;"></td>
                        <td data-title="Trial 2"><input type="number" value="0" style="min-width: 6ch;"></td>
                        <td data-title="Trial 3"><input type="number" value="0" style="min-width: 6ch;"></td>
                    </tr>
                </tbody>
            </table>
            <button class="button button--green" id="immediate-memory-end-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.addEventListener("renderTestSection", async (event) => {
                    if (event.detail === "immediate-memory") {
                        const wordlist = document.getElementById('wordlist');
                        wordlist.innerHTML = '';
                        const choices = [
                            ['Jacket', 'Arrow', 'Pepper', 'Cotton', 'Movie', 'Dollar', 'Honey', 'Mirror', 'Saddle', 'Anchor'],
                            ['Finger', 'Penny', 'Blanket', 'Lemon', 'Insect', 'Candle', 'Paper', 'Sugar', 'Sandwhich', 'Wagon'],
                            ['Baby', 'Monkey', 'Perfume', 'Sunset', 'Iron', 'Elbow', 'Apple', 'Carpet', 'Saddle', 'Bubble']
                        ];
                        const words = choices[Math.floor(Math.random() * choices.length)];
                        for (const word of words) {
                            const li = document.createElement('li');
                            li.textContent = word;
                            li.onclick = () => {
                                li.style.textDecoration = li.style.textDecoration === 'line-through' ? 'none' : 'line-through';
                            }
                            wordlist.appendChild(li);
                        }
                        saveTestResult('immediate_memory_words', words);
                    }
                });
                document.getElementById('immediate-memory-end-btn').addEventListener('click', () => {
                    const trials = document.querySelectorAll('#immediate-memory-data input');
                    const scores = Array.from(trials).map(t => parseInt(t.value));
                    saveTestResult('immediate_memory', scores.reduce((a, b) => a + b, 0));
                    saveTestResult('immediate_memory_timestamp', Date.now());
                    renderTestSection('concentration');
                });
            </script>
        </section>
    </main>
    <main style="display: none;" id="concentration">
        <section>
            <h2>Concentration</h2>
            <h3>Digits Backwards</h3>
            <p style="margin-top: 0;">Examiner, read the following numbers (one sequence from each set) and ask the athlete to repeat them back in reverse order. Say them slowly at a rate of one digit per second. Each set has two number sequences. If the athlete fails the first, try the second. If both fail, end this subsection and move on to the months in reverse order.</p>
            <p>Athlete, I'm going to read a string of numbers and when I am done, you repeat them back to me in reverse order of how I read them to you. For example, if I say 7 1 9, you would say 9 1 7. So, if I said 9 6 8 you would say? &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <ul>
                <li>4-9-3 or 6-2-9</li>
                <li>3-8-1-4 or 3-2-7-9</li>
                <li>6-2-9-7-1 or 1-5-2-8-6</li>
                <li>7-1-8-4-6-2 or 5-3-9-1-4-8</li>
            </ul>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Number of correct sets: <input type="number" id="concentration-digits" value="0"/></label>
        
            <h3>Months in Reverse Order</h3>
            <p style="margin-top: 0;">Athlete, tell me the months of the year in reverse order as QUICKLY and as accurately as possible. Start with the last month and go backward. So, you'll say December, November... go ahead &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <ul>
                <li>December</li>
                <li>November</li>
                <li>October</li>
                <li>September</li>
                <li>August</li>
                <li>July</li>
                <li>June</li>
                <li>May</li>
                <li>April</li>
                <li>March</li>
                <li>February</li>
                <li>January</li>
            </ul>
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Completed correctly: <input type="checkbox" id="concentration-months"/></label>
            <button class="button button--green" id="concentration-end-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('concentration-end-btn').addEventListener('click', () => {
                    const digits = parseInt(document.getElementById('concentration-digits').value);
                    const months = document.getElementById('concentration-months').checked ? 1 : 0;
                    saveTestResult('concentration', digits + months);
                    renderTestSection('bess');
                });
            </script>
        </section>
    </main>
    <main style="display: none;" id="bess">
        <section>
            <h2>Balance Error Scoring System <a style="font-size: 0.6em; vertical-align: middle;" href="./assets/bess_manual.pdf" target="_blank" aria-label="Manual BESS instructions"><i class="fa-solid fa-circle-info"></i></a></h2>
            <p style="margin-top: 0;">The athlete will be guided through 3 poses (double leg, tandem, and single leg stance) to be held for 20 seconds each. The later foam pad test is optional, only a solid floor/ground surface is required. You'll need a spotter to keep an eye on the athlete and be ready to assist them if they become unstable and begin to fall.</p>
            <p>The athlete should take their shoes off, roll up pant legs above ankles (if applicable), and remove any ankle taping (if applicable).</p>
            <p>Your job as examiner is to keep the camera as still as possible (minor shakes are fine) with the athlete fully in frame at all times. In case the automated system misses something, keep a count of the following errors in the athlete's execution of the poses:</p>
            <ul>
                <li style="text-align: left;">Opening eyes</li>
                <li style="text-align: left;">Lifting hands off iliac crests (upper border of the pelvis/hip-bone)</li>
                <li style="text-align: left;">Stepping, stumbling, or falling</li>
                <li style="text-align: left;">Abduction or flexion of the hip beyond 30 degrees (moving hips forwards/backwards/sideways)</li>
                <li style="text-align: left;">Twisting of the shoulder beyond 30 degrees</li>
                <li style="text-align: left;">Remaining out of the testing position for more than 5 seconds</li>
                <li style="text-align: left;">Lifting forefoot or heel</li>
            </ul>
            <p>Multiple simultaneous errors count as one. Failure to hold the pose for at least 5 seconds counts as the maximum number of errors for that pose (10).</p>

            <div id="instructions" style="bottom: 0; left: 0; width: 100%; padding: 10px; background-color: var(--secondary);" class="center"></div>
            <div style="position: relative;">
                <canvas id="canvas" width="0" height="0" style="max-width: 100%; max-height: 90vh;"></canvas>
                <video id="video" style="display:none"></video>
                <div id="status" style="opacity: 0.8; position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background-color: gray;" class="center">Getting camera permissions...</div>
            </div>
            <button class="button" id="voice-ctrl-button">Voice Ctrl &nbsp; <i class="fa-solid fa-microphone"></i></button>
            <button class="button" id="mirror-button">Mirror &nbsp; <i class="fa-solid fa-arrow-right-arrow-left"></i></button>
            <button class="button button--red" onclick="renderTestSection('manual-bess')">Assess Manually &nbsp; <i class="fa-solid fa-forward"></i></button>

            <script defer src="./lib/tensorflow/tfjs-core.js"></script>
            <script defer src="./lib/tensorflow/tfjs-converter.js"></script>
            <script defer src="./lib/tensorflow/tfjs-backend-webgl.js"></script>
            <script defer src="./lib/tensorflow/pose-detection.js"></script>
            <script defer src="./lib/tensorflow/face-detection.js"></script>
            <script defer src="./lib/tensorflow/face-landmarks-detection.js"></script>
            <script defer src="./lib/three.min.js"></script>
            <script defer src="./lib/scatter-gl.min.js"></script>
            <script defer src="./lib/tracker.js"></script>
            <script src="./bess.js" type="module"></script>
        </section>
    </main>
    <main style="display: none;" id="manual-bess">
        <section>
            <h2>Balance Error Scoring System <a style="font-size: 0.6em; vertical-align: middle;" href="./assets/bess_manual.pdf" target="_blank" aria-label="Manual BESS instructions"><i class="fa-solid fa-circle-info"></i></a></h2>
            <p style="margin-top: 0;">Examiner, you will guide the athlete through 3 poses (double leg, tandem, and single leg stance) to be held for 20 seconds each. The later foam pad test is optional, only a solid floor/ground surface is required. You'll need a spotter to keep an eye on the athlete and be ready to assist them if they become unstable and begin to fall.</p>
            <p>The athlete should take their shoes off, roll up pant legs above ankles (if applicable), and remove any ankle taping (if applicable).</p>
            <p>Keep a count of the following errors in the athlete's execution of the poses:</p>
            <ul>
                <li style="text-align: left;">Opening eyes</li>
                <li style="text-align: left;">Lifting hands off iliac crests (upper border of the pelvis/hip-bone)</li>
                <li style="text-align: left;">Stepping, stumbling, or falling</li>
                <li style="text-align: left;">Abduction or flexion of the hip beyond 30 degrees (moving hips forwards/backwards/sideways)</li>
                <li style="text-align: left;">Twisting of the shoulder beyond 30 degrees</li>
                <li style="text-align: left;">Remaining out of the testing position for more than 5 seconds</li>
                <li style="text-align: left;">Lifting forefoot or heel</li>
            </ul>
            <p>Multiple simultaneous errors count as one. Failure to hold the pose for at least 5 seconds counts as the maximum number of errors for that pose (10).</p>
        
            <h3>Double Leg Stance</h3>
            <p style="margin-top: 0;">Athlete, stand with your feet together, hands on your hips, and eyes closed. Hold this position for 20 seconds. Examiner, keep a count of the errors listed above.</p>
            <img src="assets/double_leg.png" style="height: 100%; max-height: 40vh; margin: 0 auto; margin-bottom: 6px">
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Number of errors: <input type="number" id="double-leg-errors" value="0"/></label>

            <h3>Tandem Stance</h3>
            <p style="margin-top: 0;">Athlete, stand with your feet in a heel-to-toe position, hands on your hips, and eyes closed. Hold this position for 20 seconds. Examiner, keep a count of the errors listed above.</p>
            <img src="assets/tandem_stance.png" style="height: 100%; max-height: 40vh; margin: 0 auto; margin-bottom: 6px">
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Number of errors: <input type="number" id="tandem-stance-errors" value="0"/></label>

            <h3>Single Leg Stance</h3>
            <p style="margin-top: 0;">Athlete, stand on one leg, hands on your hips, and eyes closed. Hold this position for 20 seconds. Examiner, keep a count of the errors listed above.</p>
            <img src="assets/single_leg.png" style="height: 100%; max-height: 40vh; margin: 0 auto; margin-bottom: 6px">
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Number of errors: <input type="number" id="single-leg-errors" value="0"/></label>

            <h3>Double Leg Stance on Foam (optional)</h3>
            <p style="margin-top: 0;">Athlete, stand with your feet together, hands on your hips, and eyes closed. Hold this position for 20 seconds. Examiner, keep a count of the errors listed above.</p>
            <img src="assets/double_leg.png" style="height: 100%; max-height: 40vh; margin: 0 auto; margin-bottom: 6px">
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Number of errors: <input type="number" id="double-leg-foam-errors" value="0"/></label>

            <h3>Tandem Stance on Foam (optional)</h3>
            <p style="margin-top: 0;">Athlete, stand with your feet in a heel-to-toe position, hands on your hips, and eyes closed. Hold this position for 20 seconds. Examiner, keep a count of the errors listed above.</p>
            <img src="assets/tandem_stance.png" style="height: 100%; max-height: 40vh; margin: 0 auto; margin-bottom: 6px">
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Number of errors: <input type="number" id="tandem-stance-foam-errors" value="0"/></label>

            <h3>Single Leg Stance on Foam (optional)</h3>
            <p style="margin-top: 0;">Athlete, stand on one leg, hands on your hips, and eyes closed. Hold this position for 20 seconds. Examiner, keep a count of the errors listed above.</p>
            <img src="assets/single_leg.png" style="height: 100%; max-height: 40vh; margin: 0 auto; margin-bottom: 6px">
            <label class="left-align spread-inline" style="flex-wrap: nowrap; margin-bottom: 0.4em;">Number of errors: <input type="number" id="single-leg-foam-errors" value="0"/></label>
        
            <button class="button button--green" id="bess-end-btn">Next &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script>
                document.getElementById('bess-end-btn').addEventListener('click', () => {
                    const doubleLegErrors = parseInt(document.getElementById('double-leg-errors').value);
                    const tandemStanceErrors = parseInt(document.getElementById('tandem-stance-errors').value);
                    const singleLegErrors = parseInt(document.getElementById('single-leg-errors').value);
                    const totalErrors = doubleLegErrors + tandemStanceErrors + singleLegErrors;
                    const doubleLegFoamErrors = parseInt(document.getElementById('double-leg-foam-errors').value);
                    const tandemStanceFoamErrors = parseInt(document.getElementById('tandem-stance-foam-errors').value);
                    const singleLegFoamErrors = parseInt(document.getElementById('single-leg-foam-errors').value);
                    const totalFoamErrors = doubleLegFoamErrors + tandemStanceFoamErrors + singleLegFoamErrors;
                    saveTestResult("mBESS_double_errors", doubleLegErrors);
                    saveTestResult("mBESS_single_errors", tandemStanceErrors);
                    saveTestResult("mBESS_tandem_errors", singleLegErrors);
                    saveTestResult("mBESS_total_errors", totalErrors);
                    saveTestResult("mBESS_foam_double_errors", doubleLegFoamErrors);
                    saveTestResult("mBESS_foam_single_errors", tandemStanceFoamErrors);
                    saveTestResult("mBESS_foam_tandem_errors", singleLegFoamErrors);
                    saveTestResult("mBESS_foam_total_errors", totalFoamErrors);
                    renderTestSection('tandem-gait');
                });
            </script>
        </section>
    </main>
    <main style="display: none;" id="tandem-gait">
        <section>
            <h2>Timed Tandem Gait</h2>
            <p style="margin-top: 0;">Examiner, please place a 3-meter-long line on the floor/firm surface with athletic tape. You will instruct the athlete and start/stop the timer for 3 trials.</p>
            <img src="assets/tandem-gait.png" style="width: 100%; max-width: 400px; margin: 0 auto;">
            <p>Athlete, when the timer is started, please walk heel-to-toe quickly to the end of the tape, turn around and come back as fast as you can, without separating your feet or stepping off the line &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <img src="assets/tandem-gait-side.png" style="width: 100%; max-width: 400px; margin: 0 auto; margin-bottom: 10px;">
            <table style="margin: auto;">
                <thead><tr><th>Trial 1 (seconds)</th><th>Trial 2 (seconds)</th><th>Trial 3 (seconds)</th><th>Average (seconds)</th><th>Fastest (seconds)</th></tr></thead>
                <tbody>
                    <tr id="tandem-data">
                        <td data-title="Trial 1 (seconds)"><button data-action="start-1" class="button button--green">Start Timer</button></td>
                        <td data-title="Trial 2 (seconds)">---</td>
                        <td data-title="Trial 3 (seconds)">---</td>
                        <td data-title="Average (seconds)">---</td>
                        <td data-title="Fastest (seconds)">---</td>
                    </tr>
                </tbody>
            </table>
            <p>Healthy athletes typically have a fastest time between 13.9 and 15.8. Newly concussed athletes are typically between 21.9 and 26.1. Athletes concussed within the last 6-73 days will be somewhere in between.</p>
            <button class="button button--red" onclick="renderTestSection('delayed-recall')">Unable to Tandem Walk</button>
            <button class="button button--green" style="display: none" id="start-dual-task-gait">Start Dual Task Gait &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script src="./tandem-gait.js" type="module"></script>
        </section>
    </main>
    <main style="display: none;" id="dual-task-gait">
        <section>
            <h2>Dual Task Gait (Optional)</h2>
            <p style="margin-top: 0;">Examiner, please keep the 3-meter-long athletic tape line from the Timed Gait on the floor/firm surface. You will follow the script below, click start/end timer, and click on the responses that the athlete correctly says in order. Redo trials where the athlete strays off the line.</p>
            <img src="assets/tandem-gait.png" style="width: 100%; max-width: 400px; margin: 0 auto;">
            <p>Athlete, while you are walking heel-to-toe, you will count backwards out loud by sevens. For example, if we started at 100, you would say 100, 93, 86, 79. Let's practice counting. Starting with 93, count backward by sevens until the examiner says stop &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <table style="margin: auto;">
                <thead><tr><th>Task</th><th>Correct Responses</th><th>Errors</th><th>Time (seconds)</th></tr></thead>
                <tbody>
                    <tr id="dual-task-trial-practice-data">
                        <td data-title="Task">Practice</td>
                        <td data-title="Correct Responses"><div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;"><span>93</span><span>86</span><span>79</span><span>72</span><span>65</span><span>58</span><span>51</span><span>44</span></div></td>
                        <td data-title="Errors"><input type="number" value="0" style="min-width: 6ch;"></td>
                        <td data-title="Time (seconds)"><button data-action="start-trial-practice" class="button button--green">Start Timer</button></td>
                    </tr>
                </tbody>
            </table>
            <p>Good, now you will walk heel-to-toe and count backwards out loud at the same time. Keep counting until you finish walking the 3 meters, turning 180 degrees, walking the 3 meters again and the examiner says stop indicating you got to the last number. Are you ready? The number to start with is 88. Go! &nbsp; <i class="fa-solid fa-volume-high" onclick="speak(this.parentElement.textContent)"></i></p>
            <table style="margin: auto;">
                <thead><tr><th>Task</th><th>Correct Responses</th><th>Errors</th><th>Time (seconds)</th></tr></thead>
                <tbody>
                    <tr id="dual-task-trial-1-data">
                        <td data-title="Task">Trial 1</td>
                        <td data-title="Correct Responses"><div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;"><span>88</span><span>81</span><span>74</span><span>67</span><span>60</span><span>53</span><span>46</span><span>39</span><span>32</span><span>25</span><span>18</span><span>11</span></div></td>
                        <td data-title="Errors"><input type="number" value="0" style="min-width: 6ch;"></td>
                        <td data-title="Time (seconds)"><button data-action="start-trial-1" class="button button--green">Start Timer</button></td>
                    </tr>
                    <tr id="dual-task-trial-2-data">
                        <td data-title="Task">Trial 2</td>
                        <td data-title="Correct Responses"><div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;"><span>90</span><span>83</span><span>76</span><span>69</span><span>62</span><span>55</span><span>48</span><span>41</span><span>34</span><span>27</span><span>20</span><span>13</span></div></td>
                        <td data-title="Errors"><input type="number" value="0" style="min-width: 6ch;"></td>
                        <td data-title="Time (seconds)"><button data-action="start-trial-2" class="button button--green">Start Timer</button></td>
                    </tr>
                    <tr id="dual-task-trial-3-data">
                        <td data-title="Task">Trial 3</td>
                        <td data-title="Correct Responses"><div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;"><span>98</span><span>91</span><span>84</span><span>77</span><span>70</span><span>63</span><span>56</span><span>49</span><span>42</span><span>35</span><span>28</span><span>21</span></div></td>
                        <td data-title="Errors"><input type="number" value="0" style="min-width: 6ch;"></td>
                        <td data-title="Time (seconds)"><button data-action="start-trial-3" class="button button--green">Start Timer</button></td>
                    </tr>
                </tbody>
            </table>
            <p>Healthy athletes typically complete the task in 18.7-22.5 seconds with 85.8-92.4% accuracy (0.9-1.7 errors). Concussed athletes typically take 30.6-36.1 seconds with 76.4-83.6% accuracy (2.0-2.8 errors).</p>
            <button class="button" onclick="renderTestSection('delayed-recall')">Move on to Delayed Recall &nbsp; <i class="fa-solid fa-forward"></i></button>
            <script src="./dual-task.js" type="module"></script>
        </section>
    </main>
    <main style="display: none;" id="delayed-recall">
        <section>
            <h2>Delayed Recall</h2>
            <div id="delayed-recall-content"></div>
            <script src="./delayed-recall.js" type="module"></script>
        </section>
    </main>
    <main style="display: none;" id="results">
        <section>
            <h2>Results</h2>
            <div id="results-content"><p style="margin-top: 0;">Loading...</p></div>
            <button class="button" onclick="endTest()">Return to Main Menu</button>
            <script src="./results.js" type="module"></script>
        </section>
    </main>
    <footer>
        <p><a href="https://bjsm.bmj.com/content/bjsports/57/11/622.full.pdf">SCAT6</a>  by the <a href="https://www.bmj.com/">BMJ</a> | Adaptation with permission by <a href="https://sandergi.github.io/">Alex</a> and Aureole | <a href="https://github.com/SanderGi/ConcussionAssessment">Code</a> opensource under <a href="https://github.com/SanderGi/ConcussionAssessment/blob/master/LICENSE">MIT license</a></p>
    </footer>

    <script type="module" src="scripts.js"></script>
    <script>
        // ============================ Debug ============================
        if (/dev=true/.test(window.location)) {
            import('./lib/eruda.js').then(() => eruda.init());
        }
    </script>
  </body>
</html>
